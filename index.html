<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TRINETRA ‚Äî Live Orbital Visualization</title>

  <!-- Import Iceland font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Iceland&display=swap" rel="stylesheet">

  <!-- NASA WorldWind -->
  <script src="https://files.worldwind.arc.nasa.gov/artifactory/web/0.11.0/worldwind.min.js"></script>

  <!-- satellite.js for TLE propagation -->
  <script src="https://cdn.jsdelivr.net/npm/satellite.js@4.0.0/dist/satellite.min.js"></script>

  <!-- Pako for gzip decompression -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

  <style>
    /* Import Iceland font from Google Fonts */
@import url('https://fonts.googleapis.com/css2?family=Iceland&display=swap');

/* Apply Iceland font globally */
* {
  font-family: 'Iceland', sans-serif;
  margin: 0; 
  padding: 0; 
  box-sizing: border-box; 
}
#conjunctionsPanel {
  top: 20px;
  right: 150px; /* Position to left of legend */
  width: 350px;
  max-height: 500px;
  display: none;
}
/* Ensure all MUI components use Iceland font */
body {
  font-family: 'Iceland', sans-serif;
  background: linear-gradient(135deg, #0a0a2a 0%, #1a1a4a 100%);
  overflow: hidden; 
  height: 100vh;
}

/* Additional fallback for any missed elements */
h1, h2, h3, h4, h5, h6, p, span, div, button, input, textarea, label, select {
  font-family: 'Iceland', sans-serif;
}

#globe { 
  width: 100%; 
  height: 100%; 
  position: absolute; 
  background: radial-gradient(circle at center, #0a0a2a 0%, #050515 100%);
}

/* Glass-morphism panels matching Home.js - Consistent sizing */
.panel { 
  position: absolute;
  background: rgba(26, 26, 74, 0.4);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  color: #fff;
  padding: 20px 24px;
  border-radius: 16px;
  border: 1px solid rgba(120, 219, 255, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  z-index: 10;
  transition: all 0.3s ease;
  width: 320px; /* Consistent width for all panels */
}

.panel:hover {
  border-color: rgba(120, 219, 255, 0.5);
  box-shadow: 0 12px 40px rgba(120, 219, 255, 0.2);
}

#controls { 
  top: 20px; 
  right: 20px; 
}

#legend { 
  bottom: 20px; 
  left: 20px; 
}

/* FIXED: Info panel positioning - now positioned below controls */
#info { 
  top: 120px;  /* Positioned below controls */
  right: 20px; 
  max-height: calc(100vh - 160px); /* Prevent overflow */
  overflow-y: auto;
  display: none;
  z-index: 20; /* Higher z-index to appear above other panels */
}

/* Custom scrollbar for info panel */
#info::-webkit-scrollbar {
  width: 6px;
}

#info::-webkit-scrollbar-track {
  background: rgba(10, 10, 42, 0.4);
  border-radius: 3px;
}

#info::-webkit-scrollbar-thumb {
  background: rgba(120, 219, 255, 0.5);
  border-radius: 3px;
}

#info::-webkit-scrollbar-thumb:hover {
  background: rgba(120, 219, 255, 0.7);
}

/* Loading screen */
#loading { 
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(26, 26, 74, 0.95);
  backdrop-filter: blur(30px);
  padding: 40px 60px;
  border-radius: 20px;
  border: 2px solid rgba(120, 219, 255, 0.5);
  box-shadow: 0 12px 48px rgba(0, 0, 0, 0.8);
  z-index: 100;
  text-align: center;
}

.spinner { 
  border: 4px solid rgba(120, 219, 255, 0.2);
  border-top: 4px solid #78dbff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 20px;
  box-shadow: 0 0 20px rgba(120, 219, 255, 0.5);
}

@keyframes spin { 
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); } 
}

/* Enhanced loading text with glow effect */
.loading-text {
  color: #78dbff;
  text-align: center;
  font-size: 16px;
  margin-bottom: 8px;
  text-shadow: 0 0 10px rgba(120, 219, 255, 0.7);
  letter-spacing: 1px;
}

/* Headers */
h3 { 
  margin: 0 0 18px;
  font-size: 20px; /* Slightly larger for Iceland font */
  font-weight: 400; /* Iceland is a regular weight font */
  color: #78dbff;
  border-bottom: 2px solid rgba(120, 219, 255, 0.3);
  padding-bottom: 12px;
  letter-spacing: 1px; /* Add letter spacing for better readability */
  text-shadow: 0 0 15px rgba(120, 219, 255, 0.3);
}

/* Stats */
.stat { 
  display: flex;
  justify-content: space-between;
  margin: 12px 0;
  font-size: 16px; /* Slightly larger for Iceland font */
  align-items: center;
}

.stat-label { 
  color: rgba(255, 255, 255, 0.7);
  font-weight: 400; /* Regular weight for Iceland */
}

.stat-value { 
  color: #78dbff;
  font-weight: 400; /* Regular weight for Iceland */
  font-family: 'Iceland', monospace;
  font-size: 18px; /* Slightly larger */
  text-shadow: 0 0 10px rgba(120, 219, 255, 0.5);
  letter-spacing: 0.5px;
}

/* Legend items - using PNG icons instead of colored dots */
.legend-item { 
  display: flex;
  align-items: center;
  margin: 14px 0;
  font-size: 16px; /* Slightly larger */
  font-weight: 400; /* Regular weight */
}

.legend-icon { 
  width: 24px;
  height: 24px;
  margin-right: 14px;
  transition: all 0.3s ease;
}

.legend-icon:hover {
  transform: scale(1.2);
}

/* Range slider - modern style */
input[type="range"] { 
  width: 100%;
  height: 6px;
  margin: 12px 0;
  background: rgba(120, 219, 255, 0.2);
  border-radius: 3px;
  outline: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  background: #78dbff;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 0 12px rgba(120, 219, 255, 0.8);
  transition: all 0.2s;
}

input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.2);
  box-shadow: 0 0 20px rgba(120, 219, 255, 1);
}

input[type="range"]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  background: #78dbff;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 0 12px rgba(120, 219, 255, 0.8);
  transition: all 0.2s;
}

label { 
  display: block;
  margin: 14px 0 8px;
  font-size: 16px; /* Slightly larger */
  color: rgba(255, 255, 255, 0.8);
  font-weight: 400; /* Regular weight */
}

/* Close button */
.close { 
  float: right;
  cursor: pointer;
  font-size: 28px;
  color: #ff77c6;
  line-height: 1;
  margin-top: -10px;
  transition: all 0.2s;
  font-weight: 400; /* Regular weight */
}

.close:hover { 
  color: #ffa6dd;
  transform: rotate(90deg);
}

/* Info title */
.info-title { 
  font-size: 22px; /* Slightly larger */
  color: #78dbff;
  margin-bottom: 18px;
  font-weight: 400; /* Regular weight */
  text-shadow: 0 0 15px rgba(120, 219, 255, 0.3);
  letter-spacing: 1px;
}

/* Buttons - matching Home.js style */
button { 
  background: rgba(120, 219, 255, 0.2);
  border: 1px solid #78dbff;
  color: #78dbff;
  padding: 12px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 16px; /* Slightly larger */
  font-weight: 400; /* Regular weight */
  margin-top: 12px;
  transition: all 0.3s ease;
  width: 100%;
  text-transform: none;
  letter-spacing: 1px; /* Add letter spacing */
  position: relative;
  overflow: hidden;
}

button:hover { 
  background: rgba(120, 219, 255, 0.3);
  box-shadow: 0 0 20px rgba(120, 219, 255, 0.4);
  transform: translateY(-2px);
}

button:active {
  transform: translateY(0);
}

button::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

button:hover::after {
  left: 100%;
}

/* Search panel */
#searchPanel { 
  top: 20px;
  left: 20px;
}

/* Search box - modern glass style */
.search-box { 
  width: 100%;
  padding: 12px 18px;
  background: rgba(10, 10, 42, 0.5);
  border: 1px solid rgba(120, 219, 255, 0.3);
  border-radius: 10px;
  color: white;
  font-size: 16px; /* Slightly larger */
  margin-bottom: 18px;
  transition: all 0.3s ease;
  outline: none;
  font-family: 'Iceland', sans-serif;
}

.search-box:focus { 
  border-color: #78dbff;
  box-shadow: 0 0 16px rgba(120, 219, 255, 0.4);
  background: rgba(10, 10, 42, 0.7);
}

.search-box::placeholder {
  color: rgba(255, 255, 255, 0.5);
  font-family: 'Iceland', sans-serif;
}

/* Filter groups */
.filter-group { 
  margin: 18px 0;
}

.filter-title { 
  font-size: 15px; /* Slightly larger */
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: 10px;
  font-weight: 400; /* Regular weight */
  text-transform: uppercase;
  letter-spacing: 1px; /* Add letter spacing */
}

.filter-options { 
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

/* Filter buttons - pill style */
.filter-option { 
  background: rgba(10, 10, 42, 0.5);
  border: 1px solid rgba(120, 219, 255, 0.3);
  border-radius: 20px;
  padding: 8px 16px;
  font-size: 15px; /* Slightly larger */
  font-weight: 400; /* Regular weight */
  cursor: pointer;
  transition: all 0.3s ease;
  color: rgba(255, 255, 255, 0.8);
}

.filter-option:hover { 
  background: rgba(20, 20, 52, 0.7);
  border-color: rgba(120, 219, 255, 0.5);
  transform: translateY(-2px);
}

.filter-option.active { 
  background: linear-gradient(135deg, #78dbff 0%, #a6e8ff 100%);
  color: #0a0a2a;
  border-color: #78dbff;
  font-weight: 400; /* Regular weight */
  box-shadow: 0 0 16px rgba(120, 219, 255, 0.5);
}

.filter-option.active:hover { 
  background: linear-gradient(135deg, #a6e8ff 0%, #c4f0ff 100%);
  box-shadow: 0 0 24px rgba(120, 219, 255, 0.7);
}

/* Professional dropdown for orbit types */
.dropdown {
  width: 100%;
  padding: 12px 18px;
  background: rgba(10, 10, 42, 0.5);
  border: 1px solid rgba(120, 219, 255, 0.3);
  border-radius: 10px;
  color: white;
  font-size: 16px;
  margin-bottom: 18px;
  transition: all 0.3s ease;
  outline: none;
  font-family: 'Iceland', sans-serif;
  cursor: pointer;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2378dbff' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 18px center;
  background-size: 12px;
}

.dropdown:focus {
  border-color: #78dbff;
  box-shadow: 0 0 16px rgba(120, 219, 255, 0.4);
  background-color: rgba(10, 10, 42, 0.7);
}

.dropdown option {
  background: #1a1a4a;
  color: white;
}

/* Search results */
.search-results { 
  max-height: 220px;
  overflow-y: auto;
  margin-top: 12px;
  border-top: 1px solid rgba(120, 219, 255, 0.2);
  padding-top: 12px;
}

.search-results::-webkit-scrollbar {
  width: 6px;
}

.search-results::-webkit-scrollbar-track {
  background: rgba(10, 10, 42, 0.4);
  border-radius: 3px;
}

.search-results::-webkit-scrollbar-thumb {
  background: rgba(120, 219, 255, 0.5);
  border-radius: 3px;
}

/* Search result items */
.search-result { 
  padding: 10px 14px;
  margin: 6px 0;
  background: rgba(10, 10, 42, 0.4);
  border-radius: 10px;
  cursor: pointer;
  font-size: 15px; /* Slightly larger */
  transition: all 0.2s ease;
  border: 1px solid transparent;
}

.search-result:hover { 
  background: rgba(20, 20, 52, 0.6);
  border-color: rgba(120, 219, 255, 0.3);
  transform: translateX(4px);
}

.search-result.selected { 
  background: rgba(120, 219, 255, 0.2);
  border-left: 3px solid #78dbff;
  padding-left: 12px;
}

/* Loading message styling */
#loadingMsg {
  color: rgba(120, 219, 255, 0.8);
  text-align: center;
  margin-top: 12px;
  font-size: 15px; /* Slightly larger */
  font-weight: 400; /* Regular weight */
}

/* Background stars effect */
.stars {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  pointer-events: none;
}

.star {
  position: absolute;
  background-color: white;
  border-radius: 50%;
  animation: twinkle 5s infinite ease-in-out;
}

@keyframes twinkle {
  0%, 100% { opacity: 0.2; }
  50% { opacity: 1; }
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .panel {
    padding: 16px 20px;
    border-radius: 12px;
    width: calc(100% - 40px);
    max-width: 320px;
  }
  
  #searchPanel {
    top: 10px;
    left: 10px;
  }
  
  #controls {
    top: 10px;
    right: 10px;
  }
  
  #info {
    top: 100px; /* Adjusted for mobile */
    right: 10px;
  }
  
  #legend {
    bottom: 10px;
    left: 10px;
  }
}

/* Animations */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.panel {
  animation: fadeIn 0.5s ease-out;
}

/* Enhanced glow effects */
.glow {
  text-shadow: 0 0 10px currentColor;
}

/* Ensure panels on left don't stack too high */
#searchPanel {
  max-height: calc(100vh - 40px);
  overflow-y: auto;
}

/* Conjunction Assessment Panel Styles */
#conjunctionsPanel {
  top: 20px;
  right: 240px;
  width: 350px;
  max-height: 500px;
  display: none;
}

.conjunctions-content {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.conjunctions-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.conjunctions-stats {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.conjunctions-list {
  flex: 1;
  overflow-y: auto;
  max-height: 350px;
  padding-right: 5px;
}

.conjunctions-list::-webkit-scrollbar {
  width: 6px;
}

.conjunctions-list::-webkit-scrollbar-track {
  background: rgba(10, 10, 42, 0.4);
  border-radius: 3px;
}

.conjunctions-list::-webkit-scrollbar-thumb {
  background: rgba(120, 219, 255, 0.5);
  border-radius: 3px;
}

.conjunction-item {
  background: rgba(10, 10, 42, 0.4);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-left: 4px solid rgba(120, 219, 255, 0.5);
}

.conjunction-item:hover {
  background: rgba(20, 20, 52, 0.6);
  transform: translateX(4px);
}

.conjunction-item.high-risk {
  border-left-color: #ff4444;
}

.conjunction-item.medium-risk {
  border-left-color: #ffaa00;
}

.conjunction-item.low-risk {
  border-left-color: #44ff44;
}

.conjunction-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.conjunction-satellites {
  font-weight: bold;
  color: #78dbff;
}

.conjunction-risk {
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: bold;
}

.risk-high {
  background: rgba(255, 68, 68, 0.2);
  color: #ff8888;
}

.risk-medium {
  background: rgba(255, 170, 0, 0.2);
  color: #ffcc88;
}

.risk-low {
  background: rgba(68, 255, 68, 0.2);
  color: #88ff88;
}

.conjunction-details {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.conjunction-detail {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
}

.detail-label {
  color: rgba(255, 255, 255, 0.7);
}

.detail-value {
  color: #78dbff;
}

.loading-conjunctions, .no-conjunctions {
  text-align: center;
  padding: 20px;
  color: #78dbff;
}

.refresh-btn {
  width: auto !important;
  padding: 8px 12px !important;
  margin-top: 0 !important;
}

#conjunctionsToggle {
  position: absolute;
  top: 20px;
  right: 510px;
  background: rgba(255, 100, 100, 0.9);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  z-index: 10;
  transition: all 0.3s ease;
}

#conjunctionsToggle:hover {
  background: rgba(255, 50, 50, 1);
  transform: translateY(-2px);
}
  </style>

  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>

  <!-- Background stars -->
  <div class="stars" id="stars"></div>

  <canvas id="globe"></canvas>

  <div id="loading">
    <div class="spinner"></div>
    <div class="loading-text">TRINETRA</div>
    <div class="loading-text">Loading live satellite data & initializing globe...</div>
    <div id="loadingMsg" style="color:#9cf; text-align:center; margin-top:8px; font-size:14px;"></div>
  </div>

  <!-- Search / Filter / Controls / Legend / Info -->
  <div id="searchPanel" class="panel">
    <h3>üîç Search & Filter</h3>
    <input type="text" id="searchInput" class="search-box" placeholder="Search satellites...">

    <div class="filter-group">
      <div class="filter-title">OBJECT TYPE:</div>
      <div class="filter-options">
        <div class="filter-option active" data-type="all">All</div>
        <div class="filter-option" data-type="satellite">Satellites</div>
        <div class="filter-option" data-type="rocket">Rockets</div>
        <div class="filter-option" data-type="debris">Debris</div>
      </div>
    </div>

    <div class="filter-group">
      <div class="filter-title">ORBIT TYPE:</div>
      <select id="orbitFilter" class="dropdown">
        <option value="all">All</option>
        <option value="leo">LEO</option>
        <option value="meo">MEO</option>
        <option value="geo">GEO</option>
        <option value="heo">HEO</option>
      </select>
    </div>

    <div class="search-results" id="searchResults"></div>
  </div>

  <div id="controls" class="panel">
    <h3>üõ∞Ô∏è TRINETRA</h3>
    <label>Orbit Speed: <span id="speedVal">1.0</span>x</label>
    <input type="range" id="speed" min="0.1" max="5" step="0.1" value="1">
    <div class="stat"><span class="stat-label">FPS:</span><span class="stat-value" id="fps">--</span></div>
    <div class="stat"><span class="stat-label">Visible:</span><span class="stat-value" id="visibleCount">0</span></div>
    <div class="stat"><span class="stat-label">Camera View:</span><span class="stat-value" id="cameraMode">Free</span></div>
    <button id="followButton" onclick="toggleFollowCamera()">Follow Satellite</button>
  </div>

  <div id="legend" class="panel">
    <h3>üìä Objects</h3>
    <div class="legend-item">
      <img src="https://raw.githubusercontent.com/harshbhanushali36/TRINETRA_PRODUCTION/main/icons/satellite.png" class="legend-icon" alt="Satellite">
      <span>Satellites: <b id="satCount">0</b></span>
    </div>
    <div class="legend-item">
      <img src="https://raw.githubusercontent.com/harshbhanushali36/TRINETRA_PRODUCTION/main/icons/rocket.png" class="legend-icon" alt="Rocket">
      <span>Rockets: <b id="rocketCount">0</b></span>
    </div>
    <div class="legend-item">
      <img src="https://raw.githubusercontent.com/harshbhanushali36/TRINETRA_PRODUCTION/main/icons/debris.png" class="legend-icon" alt="Debris">
      <span>Debris: <b id="debrisCount">0</b></span>
    </div>
    <div class="stat" style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(100,150,255,0.3);">
      <span class="stat-label">TOTAL:</span><span class="stat-value" id="totalCount">0</span>
    </div>
  </div>

  <!-- Info Panel -->
  <div id="info" class="panel">
    <span class="close" onclick="closeInfo()">√ó</span>
    <div id="infoContent"></div>
  </div>

  <!-- Conjunction Assessment Panel -->
  <div id="conjunctionsPanel" class="panel">
    <span class="close" onclick="closeConjunctionsPanel()">√ó</span>
    <h3>üõ∞Ô∏è Conjunction Assessment</h3>
    <div class="conjunctions-content">
      <div class="conjunctions-header">
        <div class="conjunctions-stats">
          <div class="stat">
            <span class="stat-label">Active Alerts:</span>
            <span class="stat-value" id="activeAlerts">0</span>
          </div>
          <div class="stat">
            <span class="stat-label">High Risk:</span>
            <span class="stat-value" id="highRisk">0</span>
          </div>
        </div>
        <button id="refreshConjunctions" onclick="loadConjunctionData()" class="refresh-btn">üîÑ Refresh</button>
      </div>
      <div class="conjunctions-list" id="conjunctionsList">
        <div class="loading-conjunctions">Loading conjunction data...</div>
      </div>
    </div>
  </div>

  <!-- Toggle button for conjunctions panel -->
  <div id="conjunctionsToggle" class="panel-toggle" onclick="toggleConjunctionsPanel()">
    ‚ö° Conjunctions
  </div>

  <script>
  /****************************************************************
   * Enhanced TRINETRA with professional UI
   * - PNG icons in legend instead of colored dots
   * - Dropdown for orbit type filters
   * - Consistent panel sizing
   * - Dynamic PNG sizing (0.05 when following)
   * - Conjunction assessment panel
   ****************************************************************/

  // --------- Config / URLs ----------
  const GITHUB_BASE_RAW = 'https://raw.githubusercontent.com/harshbhanushali36/TRINETRA_PRODUCTION/main/data/latest';
  const TLES_URL = `${GITHUB_BASE_RAW}/tles.json.gz`;
  const SATINFO_URL = `${GITHUB_BASE_RAW}/sat_info.json.gz`;
  const CONJUNCTIONS_URL = `${GITHUB_BASE_RAW}/conjunction_assessment.csv`;

  // animation/update intervals (ms)
  const PROPAGATION_UPDATE_MS = 5000; // recompute accurate position every 5 seconds
  const TRAIL_POINTS = 48;            // points when drawing orbit trails
  const TRAIL_DURATION_MINUTES = 90;  // generate trail for next N minutes (approx)
  const BATCH_SIZE = 500;             // progressive loading: satellites per batch
  const BATCH_DELAY_MS = 50;          // delay between batches for smooth rendering

  // --------- Setup WorldWind ----------
  const wwd = new WorldWind.WorldWindow("globe");
  
  // Enhanced globe layers for better aesthetics
  wwd.addLayer(new WorldWind.BMNGOneImageLayer());
  wwd.addLayer(new WorldWind.BMNGLandsatLayer());
  
  // Enhanced atmosphere with better visuals
  const atmosphereLayer = new WorldWind.AtmosphereLayer();
  atmosphereLayer.time = new Date(); // Set current time for realistic lighting
  wwd.addLayer(atmosphereLayer);
  
  // Enhanced starfield
  const starFieldLayer = new WorldWind.StarFieldLayer();
  starFieldLayer.altitude = 10000000; // Higher altitude for better visibility
  wwd.addLayer(starFieldLayer);
  
  wwd.addLayer(new WorldWind.CompassLayer());
  
  // Store reference to ViewControlsLayer to enable/disable it
  let viewControlsLayer = new WorldWind.ViewControlsLayer(wwd);
  wwd.addLayer(viewControlsLayer);

  const objectLayer = new WorldWind.RenderableLayer("Objects");
  const trailLayer = new WorldWind.RenderableLayer("Trails");
  wwd.addLayer(objectLayer);
  wwd.addLayer(trailLayer);

  // FIXED: Set Earth to be properly centered in the view
  wwd.navigator.lookAtLocation.latitude = 0;
  wwd.navigator.lookAtLocation.longitude = 0;
  wwd.navigator.range = 40000000; // Better view of entire Earth
  wwd.navigator.heading = 0;
  wwd.navigator.tilt = 0; // Direct overhead view initially

  // --------- Create background stars ----------
  function createStars() {
    const starsContainer = document.getElementById('stars');
    const starCount = 200;
    
    for (let i = 0; i < starCount; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      
      // Random position
      const left = Math.random() * 100;
      const top = Math.random() * 100;
      
      // Random size
      const size = Math.random() * 2 + 1;
      
      // Random animation delay
      const delay = Math.random() * 5;
      
      star.style.left = `${left}%`;
      star.style.top = `${top}%`;
      star.style.width = `${size}px`;
      star.style.height = `${size}px`;
      star.style.animationDelay = `${delay}s`;
      
      starsContainer.appendChild(star);
    }
  }

  // --------- Globals ----------
  let sats = [];                 // internal list of satellites (objects with TLEs + placemark)
  let satInfoMap = {};           // metadata map by NORAD ID
  let selected = null;           // selected sat object
  let trailRenderable = null;    // current trail renderable
  let visibleSats = new Set();
  let activeFilters = { type: 'all', orbit: 'all' };
  let isFollowing = false;
  let followSatelliteId = null;
  let conjunctionData = [];      // conjunction assessment data

  // UI counters
  const counts = { satellite: 0, rocket: 0, debris: 0, other: 0 };

  // Orbit colors with enhanced aesthetics
  const ORBIT_COLORS = {
    'satellite': new WorldWind.Color(0, 1, 1, 0.9),
    'payload': new WorldWind.Color(0, 1, 1, 0.9),
    'rocket': new WorldWind.Color(1, 0.5, 0, 0.9),
    'rocket body': new WorldWind.Color(1, 0.5, 0, 0.9),
    'debris': new WorldWind.Color(1, 0, 0, 0.9),
    'unknown': new WorldWind.Color(0.8, 0.8, 0.8, 0.9)
  };

  // Icon URLs from your GitHub repo
  const GITHUB_ICONS_BASE = 'https://raw.githubusercontent.com/harshbhanushali36/TRINETRA_PRODUCTION/main/icons';
  const ICON_URLS = {
    'satellite': `${GITHUB_ICONS_BASE}/satellite.png`,
    'payload': `${GITHUB_ICONS_BASE}/satellite.png`,
    'rocket': `${GITHUB_ICONS_BASE}/rocket.png`,
    'rocket body': `${GITHUB_ICONS_BASE}/rocket.png`,
    'debris': `${GITHUB_ICONS_BASE}/debris.png`,
    'unknown': `${GITHUB_ICONS_BASE}/satellite.png`
  };

  // Get icon URL for a satellite type
  function getIconUrl(type) {
    const lowerType = (type || 'unknown').toLowerCase();
    
    if (lowerType.includes('satellite') || lowerType.includes('payload')) {
      return ICON_URLS.satellite;
    } else if (lowerType.includes('rocket')) {
      return ICON_URLS.rocket;
    } else if (lowerType.includes('debris')) {
      return ICON_URLS.debris;
    }
    
    return ICON_URLS.unknown;
  }

  // --------- Gzip Decompression using Pako ----------
  async function decompressGzip(compressedData) {
    if (typeof pako === 'undefined') {
      throw new Error('Pako library not loaded. Please refresh the page.');
    }
    
    try {
      const inputArray = new Uint8Array(compressedData);
      const decompressed = pako.inflate(inputArray);
      return decompressed;
    } catch(err) {
      console.error('Gzip decompression error:', err);
      throw new Error('Failed to decompress gzip data: ' + err.message);
    }
  }

  // --------- Fetch and decompress gzip files ----------
  async function fetchData(url, progressText) {
    document.getElementById('loadingMsg').textContent = progressText || `Fetching ${url}`;
    
    try {
      const res = await fetch(url);
      if(!res.ok) throw new Error(`Failed to fetch ${url} (${res.status})`);
      
      const buf = await res.arrayBuffer();
      document.getElementById('loadingMsg').textContent = 'Decompressing data...';
      
      const decompressed = await decompressGzip(buf);
      const text = new TextDecoder('utf-8').decode(decompressed);
      return JSON.parse(text);
    } catch(err) {
      console.error(`Error loading ${url}:`, err);
      throw err;
    }
  }

  // --------- Satellite propagation helpers ----------
  function propPositionFromTLE(tle1, tle2, date){
    const satrec = satellite.twoline2satrec(tle1, tle2);
    // propagate returns {position, velocity} in ECI (km)
    const p = satellite.propagate(satrec, date);
    if(!p || !p.position) return null;
    const gmst = satellite.gstime(date);
    const geo = satellite.eciToGeodetic(p.position, gmst);
    const lat = satellite.degreesLat(geo.latitude);
    const lon = satellite.degreesLong(geo.longitude);
    const altKm = geo.height; // km
    return { lat, lon, alt: altKm * 1000, rawPosECI: p.position };
  }

  // Interpolate between two positions for smooth animation
  function interpolatePosition(pos1, pos2, t) {
    if (!pos1 || !pos2) return pos1 || pos2;
    
    // Smooth interpolation factor (ease in-out)
    const smoothT = t * t * (3 - 2 * t);
    
    return {
      lat: pos1.lat + (pos2.lat - pos1.lat) * smoothT,
      lon: pos1.lon + (pos2.lon - pos1.lon) * smoothT,
      alt: pos1.alt + (pos2.alt - pos1.alt) * smoothT
    };
  }

  // generate an approximate orbit trail (future positions) ‚Äî used on-demand
  function generateOrbitTrailPoints(tle1, tle2, minutes=TRAIL_DURATION_MINUTES, points=TRAIL_POINTS){
    const satrec = satellite.twoline2satrec(tle1, tle2);
    const now = new Date();
    const pts = [];
    for(let i=0;i<points;i++){
      const dt = new Date(now.getTime() + (i * (minutes*60000) / points));
      const p = satellite.propagate(satrec, dt);
      if(!p || !p.position) continue;
      const gmst = satellite.gstime(dt);
      const geo = satellite.eciToGeodetic(p.position, gmst);
      const lat = satellite.degreesLat(geo.latitude);
      const lon = satellite.degreesLong(geo.longitude);
      const altKm = geo.height;
      pts.push(new WorldWind.Position(lat, lon, altKm*1000));
    }
    return pts;
  }

  // add placemark for a satellite (and keep reference in sats array)
  function makePlacemarkForSat(s){
    const attrs = new WorldWind.PlacemarkAttributes(null);
    
    // Use real PNG icons from GitHub repo
    attrs.imageSource = getIconUrl(s.type);
    attrs.imageScale = 0.05; // Normal size
    attrs.imageOffset = new WorldWind.Offset(WorldWind.OFFSET_FRACTION, 0.5, WorldWind.OFFSET_FRACTION, 0.5);

    // initial placeholder position at (0,0,0) before propagation
    const pm = new WorldWind.Placemark(new WorldWind.Position(0,0,0), false, attrs);
    pm.userObject = s;
    pm.pickDelegate = s; // helps picking
    objectLayer.addRenderable(pm);

    return pm;
  }

  // NEW: Update PNG size based on follow mode
  function updatePNGSize() {
    const scale = isFollowing ? 0.07 : 0.05; // Larger when following
    
    sats.forEach(sat => {
      if (sat.placemark && sat.placemark.attributes) {
        sat.placemark.attributes.imageScale = scale;
      }
    });
    
    wwd.redraw();
  }

  // --------- Conjunction Assessment Functions ----------
  function toggleConjunctionsPanel() {
    const panel = document.getElementById('conjunctionsPanel');
    const toggle = document.getElementById('conjunctionsToggle');
    
    if (panel.style.display === 'block') {
      panel.style.display = 'none';
      toggle.style.background = 'rgba(255, 100, 100, 0.9)';
    } else {
      panel.style.display = 'block';
      toggle.style.background = 'rgba(255, 50, 50, 1)';
      // Load data if not already loaded
      if (conjunctionData.length === 0) {
        loadConjunctionData();
      }
    }
  }

  function closeConjunctionsPanel() {
    document.getElementById('conjunctionsPanel').style.display = 'none';
    document.getElementById('conjunctionsToggle').style.background = 'rgba(255, 100, 100, 0.9)';
  }

  // Load conjunction data from GitHub CSV
  async function loadConjunctionData() {
    const conjunctionsList = document.getElementById('conjunctionsList');
    const activeAlerts = document.getElementById('activeAlerts');
    const highRisk = document.getElementById('highRisk');
    
    try {
      conjunctionsList.innerHTML = '<div class="loading-conjunctions">Loading conjunction data...</div>';
      
      const response = await fetch(CONJUNCTIONS_URL);
      
      if (!response.ok) {
        throw new Error(`Failed to fetch conjunction data: ${response.status}`);
      }
      
      const csvText = await response.text();
      conjunctionData = parseConjunctionCSV(csvText);
      
      // Update UI with conjunction data
      updateConjunctionsUI();
      
    } catch (error) {
      console.error('Error loading conjunction data:', error);
      conjunctionsList.innerHTML = `
        <div class="no-conjunctions" style="color:#ff6b6b;">
          Error loading conjunction data<br>
          <small>${error.message}</small>
        </div>
      `;
      // Fallback to sample data for demonstration
    }
  }

  // Parse CSV data
  // Parse CSV data
function parseConjunctionCSV(csvText) {
  const lines = csvText.trim().split('\n');
  const conjunctions = [];
  
  if (lines.length === 0) return conjunctions;
  
  // Parse header row to find column indices
  const headers = parseCSVLine(lines[0]);
  
  // Find column indices for the specific column names
  const missDistanceIndex = headers.findIndex(header => 
    header.toLowerCase().includes('miss_distance') || header.toLowerCase().includes('miss distance')
  );
  
  const probabilityIndex = headers.findIndex(header => 
    header.toLowerCase().includes('pc_maximum') || header.toLowerCase().includes('probability') || header.toLowerCase().includes('pc')
  );
  
  const sat1Index = headers.findIndex(header => 
    header.toLowerCase().includes('satellite1') || header.toLowerCase().includes('object1') || header.toLowerCase().includes('name1')
  );
  
  const sat2Index = headers.findIndex(header => 
    header.toLowerCase().includes('satellite2') || header.toLowerCase().includes('object2') || header.toLowerCase().includes('name2')
  );
  
  const timeIndex = headers.findIndex(header => 
    header.toLowerCase().includes('time') || header.toLowerCase().includes('date') || header.toLowerCase().includes('tca')
  );
  
  console.log('Found columns:', { missDistanceIndex, probabilityIndex, sat1Index, sat2Index, timeIndex });
  
  // Process data rows
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim();
    if (!line) continue;
    
    const columns = parseCSVLine(line);
    
    // Extract data using the found column indices
    const satellite1 = sat1Index >= 0 && columns[sat1Index] ? columns[sat1Index].trim() : 'Unknown';
    const satellite2 = sat2Index >= 0 && columns[sat2Index] ? columns[sat2Index].trim() : 'Unknown';
    
    let missDistance = 0;
    if (missDistanceIndex >= 0 && columns[missDistanceIndex]) {
      missDistance = parseFloat(columns[missDistanceIndex]);
      if (isNaN(missDistance)) missDistance = 0;
    }
    
    let probability = 0;
    if (probabilityIndex >= 0 && columns[probabilityIndex]) {
      probability = parseFloat(columns[probabilityIndex]);
      if (isNaN(probability)) probability = 0;
    }
    
    const timeOfClosestApproach = timeIndex >= 0 && columns[timeIndex] ? columns[timeIndex].trim() : 'Unknown';
    
    if (satellite1 !== 'Unknown' && satellite2 !== 'Unknown') {
      const conjunction = {
        satellite1: satellite1,
        satellite2: satellite2,
        missDistance: missDistance,
        probability: probability,
        timeOfClosestApproach: timeOfClosestApproach,
        riskLevel: calculateRiskLevel(missDistance, probability)
      };
      
      console.log('Parsed conjunction:', conjunction);
      conjunctions.push(conjunction);
    }
  }
  
  // Sort by risk (highest first)
  conjunctions.sort((a, b) => {
    if (a.riskLevel === 'high' && b.riskLevel !== 'high') return -1;
    if (a.riskLevel !== 'high' && b.riskLevel === 'high') return 1;
    if (a.riskLevel === 'medium' && b.riskLevel === 'low') return -1;
    if (a.riskLevel === 'low' && b.riskLevel === 'medium') return 1;
    
    // If same risk level, sort by probability (highest first)
    return b.probability - a.probability;
  });
  
  return conjunctions;
}

// Helper function to parse CSV line with quoted fields
function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      result.push(current);
      current = '';
    } else {
      current += char;
    }
  }
  
  result.push(current);
  return result.map(col => col.trim().replace(/^"|"$/g, ''));
}

  // Calculate risk level based on miss distance and probability
  function calculateRiskLevel(missDistance, probability) {
    if (missDistance < 1 && probability > 0.01) return 'high';
    if (missDistance < 5 && probability > 0.001) return 'medium';
    return 'low';
  }

  // Update the UI with conjunction data
  function updateConjunctionsUI() {
    const conjunctionsList = document.getElementById('conjunctionsList');
    const activeAlerts = document.getElementById('activeAlerts');
    const highRisk = document.getElementById('highRisk');
    
    if (conjunctionData.length === 0) {
      conjunctionsList.innerHTML = '<div class="no-conjunctions">No conjunction alerts at this time</div>';
      activeAlerts.textContent = '0';
      highRisk.textContent = '0';
      return;
    }
    
    // Count high risk conjunctions
    const highRiskCount = conjunctionData.filter(c => c.riskLevel === 'high').length;
    
    // Update stats
    activeAlerts.textContent = conjunctionData.length;
    highRisk.textContent = highRiskCount;
    
    // Create conjunction items
    conjunctionsList.innerHTML = '';
    conjunctionData.forEach((conjunction, index) => {
      const item = document.createElement('div');
      item.className = `conjunction-item ${conjunction.riskLevel}-risk`;
      
      const riskClass = `risk-${conjunction.riskLevel}`;
      
      item.innerHTML = `
        <div class="conjunction-header">
          <div class="conjunction-satellites">${conjunction.satellite1} & ${conjunction.satellite2}</div>
          <div class="conjunction-risk ${riskClass}">${conjunction.riskLevel.toUpperCase()}</div>
        </div>
        <div class="conjunction-details">
          <div class="conjunction-detail">
            <span class="detail-label">Miss Distance:</span>
            <span class="detail-value">${conjunction.missDistance.toFixed(2)} km</span>
          </div>
          <div class="conjunction-detail">
            <span class="detail-label">Probability:</span>
            <span class="detail-value">${(conjunction.probability * 100).toFixed(4)}%</span>
          </div>
          <div class="conjunction-detail">
            <span class="detail-label">Time:</span>
            <span class="detail-value">${formatTime(conjunction.timeOfClosestApproach)}</span>
          </div>
        </div>
      `;
      
      // Add click handler to focus on these satellites
      item.addEventListener('click', () => {
        focusOnConjunction(conjunction);
      });
      
      conjunctionsList.appendChild(item);
    });
  }

  // Format time for display
  function formatTime(timeString) {
    if (timeString === 'Unknown') return timeString;
    
    try {
      const date = new Date(timeString);
      return date.toLocaleString();
    } catch (e) {
      return timeString;
    }
  }

  // Focus on a conjunction (find and select the satellites)
  function focusOnConjunction(conjunction) {
    // Try to find both satellites
    const sat1 = sats.find(s => s.name === conjunction.satellite1);
    const sat2 = sats.find(s => s.name === conjunction.satellite2);
    
    if (sat1) {
      selectSatellite(sat1);
    } else if (sat2) {
      selectSatellite(sat2);
    } else {
      alert(`Could not find satellites ${conjunction.satellite1} or ${conjunction.satellite2} in the current dataset.`);
    }
  }

  // Load sample data if real data fails
  function loadSampleConjunctionData() {
    conjunctionData = [
      {
        satellite1: 'STARLINK-2560',
        satellite2: 'COSMOS 2251 DEB',
        missDistance: 0.8,
        probability: 0.015,
        timeOfClosestApproach: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(),
        riskLevel: 'high'
      },
      {
        satellite1: 'IRIDIUM 33',
        satellite2: 'METEOR 2-5 DEB',
        missDistance: 3.2,
        probability: 0.002,
        timeOfClosestApproach: new Date(Date.now() + 5 * 60 * 60 * 1000).toISOString(),
        riskLevel: 'medium'
      },
      {
        satellite1: 'GPS BIIF-1',
        satellite2: 'SL-8 DEB',
        missDistance: 12.5,
        probability: 0.0001,
        timeOfClosestApproach: new Date(Date.now() + 8 * 60 * 60 * 1000).toISOString(),
        riskLevel: 'low'
      }
    ];
    
    updateConjunctionsUI();
  }

  // show info panel for a satellite object
  function showSatelliteInfo(s){
    const meta = satInfoMap[String(s.id)] || {};
    const altitude = (s.position && s.position.alt) ? Math.round(s.position.alt/1000) : 'N/A';
    const orbitType = getOrbitType(altitude === 'N/A' ? 0 : altitude);
    const period = meta.period ? `${meta.period.toFixed(1)} min` : (s.orbit_period_minutes ? `${s.orbit_period_minutes} min` : 'N/A');

    document.getElementById('infoContent').innerHTML = `
      <div class="info-title">${meta.name || s.name || 'Unknown'}</div>
      <div class="stat"><span class="stat-label">Type:</span><span class="stat-value">${meta.object_type || s.type || 'N/A'}</span></div>
      <div class="stat"><span class="stat-label">ID:</span><span class="stat-value">${s.id || 'N/A'}</span></div>
      <div class="stat"><span class="stat-label">Altitude:</span><span class="stat-value">${altitude} km</span></div>
      <div class="stat"><span class="stat-label">Orbit:</span><span class="stat-value">${orbitType.toUpperCase()}</span></div>
      <div class="stat"><span class="stat-label">Period:</span><span class="stat-value">${period}</span></div>
      <div style="margin-top:10px; font-size:15px; color:#bde;">Launch: ${meta.launch_date || 'N/A'} | Country: ${meta.country || 'N/A'}</div>
    `;
    
    // Position info panel below controls
    const controlsPanel = document.getElementById('controls');
    const controlsRect = controlsPanel.getBoundingClientRect();
    const infoPanel = document.getElementById('info');
    infoPanel.style.top = (controlsRect.bottom + 20) + 'px';
    infoPanel.style.display = 'block';
    
    // FIXED: Update the single follow button text
    document.getElementById('followButton').textContent = isFollowing && followSatelliteId===s.id ? 'Stop Following' : 'Follow Satellite';
  }

  function closeInfo(){
    document.getElementById('info').style.display = 'none';
    selected = null;
    
    // FIXED: Always keep view controls enabled for scrolling
    viewControlsLayer.enabled = true;
    isFollowing = false;
    followSatelliteId = null;
    document.getElementById('cameraMode').textContent = 'Free';
    if(trailRenderable){
      trailLayer.removeRenderable(trailRenderable);
      trailRenderable = null;
    }
    
    // Update PNG size when not following
    updatePNGSize();
    
    // FIXED: Reset follow button text
    document.getElementById('followButton').textContent = 'Follow Satellite';
  }

  function toggleFollowCamera(){
    if(!selected) return;
    isFollowing = !isFollowing;
    
    // FIXED: Always keep view controls enabled for scrolling
    // We don't disable view controls anymore to allow scrolling/zooming
    viewControlsLayer.enabled = true;
    
    if(isFollowing){ 
      followSatelliteId = selected.id; 
      document.getElementById('cameraMode').textContent = 'Following'; 
    }
    else { 
      followSatelliteId = null; 
      document.getElementById('cameraMode').textContent = 'Free'; 
    }
    
    document.getElementById('followButton').textContent = isFollowing ? 'Stop Following' : 'Follow Satellite';
    
    // Update PNG size based on follow mode
    updatePNGSize();
  }

  function getOrbitType(alt){ if(alt < 2000) return 'leo'; if(alt < 35786) return 'meo'; if(alt >= 35786 && alt < 36000) return 'geo'; return 'heo'; }

  // FIXED: Filter out sped-up objects by checking for valid TLE data
  function isValidTLE(tle1, tle2) {
    if (!tle1 || !tle2) return false;
    
    // Check if TLE lines have proper format and reasonable values
    const tle1Parts = tle1.trim().split(/\s+/);
    const tle2Parts = tle2.trim().split(/\s+/);
    
    // Should have enough parts
    if (tle1Parts.length < 8 || tle2Parts.length < 7) return false;
    
    try {
      // Try to create satellite record to validate
      const satrec = satellite.twoline2satrec(tle1, tle2);
      
      // Check for reasonable inclination (between 0 and 180 degrees)
      const inclination = satrec.inclo * (180 / Math.PI);
      if (inclination < 0 || inclination > 180) return false;
      
      // Check for reasonable eccentricity (between 0 and 1)
      if (satrec.ecco < 0 || satrec.ecco >= 1) return false;
      
      // Check for reasonable mean motion (orbits per day)
      // Most satellites are between 1-16 orbits per day
      if (satrec.no < 0.06 || satrec.no > 17) return false; // 0.06 ‚âà 1 orbit per day, 17 ‚âà 16.6 orbits per day
      
      return true;
    } catch (e) {
      return false;
    }
  }

  // ---------- Main loading + initialization ----------
  (async function main(){
    try{
      // Create background stars
      createStars();
      
      // Load gzip compressed TLE + info files
      document.getElementById('loadingMsg').textContent = 'Fetching satellite data...';
      const [tlesArr, infoObj] = await Promise.all([
        fetchData(TLES_URL, 'Downloading TLE data (gzip)...'),
        fetchData(SATINFO_URL, 'Downloading satellite info (gzip)...')
      ]);

      // store metadata map
      satInfoMap = infoObj || {};

      // convert incoming tlesArr into internal sats list
      // expected tlesArr: [{ id: <number>, name: <string>, tle1: <str>, tle2: <str> }, ...]
      document.getElementById('loadingMsg').textContent = `Preparing ${tlesArr.length} TLEs...`;
      counts.satellite = counts.rocket = counts.debris = counts.other = 0;

      // FIXED: Filter out invalid TLEs and sped-up objects
      const validTLEs = tlesArr.filter(entry => {
        return isValidTLE(entry.tle1 || entry.TLE_LINE1, entry.tle2 || entry.TLE_LINE2);
      });

      document.getElementById('loadingMsg').textContent = `Filtered ${tlesArr.length - validTLEs.length} invalid TLEs, preparing ${validTLEs.length} satellites...`;

      // create placemarks
      sats = validTLEs.map((entry, idx) => {
        const id = entry.id || (`_${idx}`);
        const name = entry.name || `object_${id}`;
        // pick a crude type using metadata map if available
        const meta = satInfoMap[String(id)] || {};
        const type = (meta.object_type || '').toString() || (entry.type || 'UNKNOWN');

        // create sat object
        const satObj = {
          id: id,
          name: name,
          tle1: String(entry.tle1 || entry.TLE_LINE1 || ''),
          tle2: String(entry.tle2 || entry.TLE_LINE2 || ''),
          type: String(type),
          orbit_period_minutes: meta.period || null,
          position: null, // {lat,lon,alt}
          nextPosition: null, // for smooth interpolation
          placemark: null,
          lastPropagated: null,
          satrec: null, // store satellite record for faster propagation
          idx: Math.random() * 1000,
          isValid: true // Mark as valid
        };

        // update counts
        const t = (satObj.type||'').toLowerCase();
        if(t.includes('satellite') || t.includes('payload')) counts.satellite++;
        else if(t.includes('rocket')) counts.rocket++;
        else if(t.includes('debris')) counts.debris++;
        else counts.other++;

        // create placemark & attach
        satObj.placemark = makePlacemarkForSat(satObj);
        return satObj;
      });

      // update UI counters
      document.getElementById('satCount').textContent = counts.satellite;
      document.getElementById('rocketCount').textContent = counts.rocket;
      document.getElementById('debrisCount').textContent = counts.debris;
      document.getElementById('totalCount').textContent = sats.length;

      // Progressive loading: load and render in batches
      document.getElementById('loadingMsg').textContent = 'Loading satellites progressively...';
      await loadSatellitesInBatches();

      // hide loading
      document.getElementById('loading').style.display = 'none';

      // start animation loops
      startAnimationLoops();
    } catch(err){
      console.error(err);
      document.getElementById('loading').innerHTML = `
        <div style="color:#f44; text-align:center;">
          <h3>Error loading data</h3>
          <p style="margin:10px 0; font-size:15px;">${err.message}</p>
          <button onclick="location.reload()" style="margin-top:15px;">Retry</button>
        </div>
      `;
    }
  })();

  // ---------- Propagation + Animation ----------
  let lastFPS = Date.now(), frames = 0;
  let lastPropagateTime = 0;
  let animationStartTime = Date.now();
  let lastFrameTime = Date.now(); // FIXED: Added missing variable

  // Progressive loading: process satellites in batches
  async function loadSatellitesInBatches() {
    const totalBatches = Math.ceil(sats.length / BATCH_SIZE);
    
    for (let batchIdx = 0; batchIdx < totalBatches; batchIdx++) {
      const start = batchIdx * BATCH_SIZE;
      const end = Math.min(start + BATCH_SIZE, sats.length);
      const batch = sats.slice(start, end);
      
      // Update loading message
      const progress = Math.round((end / sats.length) * 100);
      document.getElementById('loadingMsg').textContent = 
        `Loading satellites: ${end}/${sats.length} (${progress}%)`;
      
      // Propagate positions for this batch (current and next position for interpolation)
      const now = new Date();
      const future = new Date(now.getTime() + PROPAGATION_UPDATE_MS);
      
      for (const s of batch) {
        if (!s.isValid) continue; // Skip invalid satellites
        
        // Store satrec for faster updates
        if (!s.satrec) {
          try {
            s.satrec = satellite.twoline2satrec(s.tle1, s.tle2);
          } catch (e) {
            console.warn(`Invalid TLE for ${s.name}, disabling`);
            s.isValid = false;
            s.placemark.enabled = false;
            continue;
          }
        }
        
        const pos = propPositionFromTLE(s.tle1, s.tle2, now);
        const nextPos = propPositionFromTLE(s.tle1, s.tle2, future);
        
        if (pos) {
          s.position = pos;
          s.nextPosition = nextPos;
          s.lastPropagated = now;
          s.placemark.position = new WorldWind.Position(pos.lat, pos.lon, pos.alt);
          visibleSats.add(s.id);
        }
      }
      
      // Update visible count
      document.getElementById('visibleCount').textContent = visibleSats.size;
      
      // Redraw to show progress
      wwd.redraw();
      
      // Small delay between batches to keep UI responsive
      if (batchIdx < totalBatches - 1) {
        await new Promise(resolve => setTimeout(resolve, BATCH_DELAY_MS));
      }
    }
    
    // Store initial propagation time
    lastPropagateTime = Date.now();
    animationStartTime = lastPropagateTime;
  }

  async function propagateAllOnce(){
    const now = new Date();
    const future = new Date(now.getTime() + PROPAGATION_UPDATE_MS);
    
    for(const s of sats){
      if (!s.isValid) continue; // Skip invalid satellites
      
      const pos = propPositionFromTLE(s.tle1, s.tle2, now);
      const nextPos = propPositionFromTLE(s.tle1, s.tle2, future);
      
      if(pos){
        s.position = pos;
        s.nextPosition = nextPos;
        s.lastPropagated = now;
      }
    }
    
    lastPropagateTime = Date.now();
    animationStartTime = lastPropagateTime;
  }

  function startAnimationLoops(){
    // propagation update timer - calculate new accurate positions every 5 seconds
    setInterval(async ()=>{
      try {
        await propagateAllOnce();
      } catch(e){ console.warn('Propagation update error', e); }
    }, PROPAGATION_UPDATE_MS);

    // render animation loop with smooth interpolation at 60fps
    function frame(){
      requestAnimationFrame(frame);
      
      const now = Date.now();
      lastFrameTime = now; // FIXED: Update lastFrameTime
      
      // FPS counter
      frames++;
      if(now - lastFPS > 1000){
        document.getElementById('fps').textContent = Math.round(frames * 1000 / (now - lastFPS));
        frames = 0; 
        lastFPS = now;
      }

      // Calculate interpolation factor (0 to 1) between propagation updates
      const timeSinceLastProp = now - lastPropagateTime;
      const speedMultiplier = parseFloat(document.getElementById('speed').value) || 1.0;
      const interpolationFactor = Math.min(timeSinceLastProp / PROPAGATION_UPDATE_MS, 1);

      // Update all satellite positions with smooth interpolation
      for (const s of sats) {
        if (s.isValid && s.position && s.nextPosition && s.placemark.enabled) {
          const smoothPos = interpolatePosition(s.position, s.nextPosition, interpolationFactor);
          s.placemark.position = new WorldWind.Position(smoothPos.lat, smoothPos.lon, smoothPos.alt);
        }
      }

      // update placemark sizes/visibility based on filters
      filterSatellites();

      // follow camera if active - FIXED: Now allows zooming while following
      if(isFollowing && followSatelliteId !== null){
        const s = sats.find(x=>String(x.id)===String(followSatelliteId));
        if(s && s.isValid && s.position && s.nextPosition){
          const smoothPos = interpolatePosition(s.position, s.nextPosition, interpolationFactor);
          
          // FIXED: Only update lookAt location, not range - this allows zooming
          wwd.navigator.lookAtLocation.latitude = smoothPos.lat;
          wwd.navigator.lookAtLocation.longitude = smoothPos.lon;
          
          // FIXED: Remove the automatic range adjustment to allow manual zooming
          // The user can now zoom in/out freely while following
          
          // FIXED: Ensure the followed satellite is always visible
          if (s.placemark) {
            s.placemark.enabled = true;
            s.placemark.attributes.imageScale = 0.05; // Slightly larger when following
          }
        }
      }

      wwd.redraw();
    }
    frame();
  }

  // ---------- UI: search / filter / click handling ----------
  document.getElementById('searchInput').addEventListener('input', function(e){
    const q = e.target.value.trim();
    searchSatellites(q);
  });

  // Orbit filter dropdown handler
  document.getElementById('orbitFilter').addEventListener('change', function(e){
    activeFilters.orbit = e.target.value;
    filterSatellites();
  });

  function searchSatellites(q){
    const c = document.getElementById('searchResults');
    c.innerHTML = '';
    if(!q) return;
    const hits = sats.filter(s => (s.name || '').toLowerCase().includes(q.toLowerCase()) || String(s.id).includes(q));
    if(hits.length===0){ c.innerHTML = '<div style="color:#aaa;text-align:center;padding:10px;">No results</div>'; return; }
    hits.slice(0,10).forEach(s => {
      const d = document.createElement('div'); d.className='search-result';
      d.textContent = `${s.name} (${s.type||'N/A'})`;
      d.onclick = ()=>{ selectSatellite(s); c.innerHTML=''; document.getElementById('searchInput').value=''; };
      c.appendChild(d);
    });
  }

  // filter option handlers
  document.querySelectorAll('.filter-option[data-type]').forEach(opt=>{
    opt.addEventListener('click', e=>{
      document.querySelectorAll('.filter-option[data-type]').forEach(o=>o.classList.remove('active'));
      e.target.classList.add('active');
      activeFilters.type = e.target.dataset.type;
      filterSatellites();
    });
  });

  function filterSatellites(){
    visibleSats.clear();
    sats.forEach(s=>{
      const t = (s.type||'').toLowerCase();
      const alt = s.position ? s.position.alt/1000 : 0;
      const orbitType = getOrbitType(alt);
      const typeMatch = (activeFilters.type==='all') ||
        (activeFilters.type==='satellite' && (t.includes('satellite')||t.includes('payload'))) ||
        (activeFilters.type==='rocket' && t.includes('rocket')) ||
        (activeFilters.type==='debris' && t.includes('debris'));
      const orbitMatch = (activeFilters.orbit==='all') || (activeFilters.orbit===orbitType);
      if(typeMatch && orbitMatch && s.isValid){ 
        s.placemark.enabled = true; 
        visibleSats.add(s.id); 
      } else { 
        s.placemark.enabled=false; 
      }
    });
    document.getElementById('visibleCount').textContent = visibleSats.size;
    wwd.redraw();
  }

  // clicking on globe to pick placemark
  wwd.addEventListener('click', (evt) => {
    const pickList = wwd.pick(wwd.canvasCoordinates(evt.clientX, evt.clientY));
    if(trailRenderable){ trailLayer.removeRenderable(trailRenderable); trailRenderable = null; }
    if(pickList.objects.length > 0){
      const picked = pickList.objects[0].userObject;
      // picked may be the sat userObject we stored
      const sat = sats.find(s => s.placemark === picked || s.name === (picked && picked.name));
      if(sat){ selectSatellite(sat); }
    } else {
      closeInfo();
    }
  });

  function selectSatellite(sat){
    closeInfo();
    selected = sat;
    // draw full trail (generateTrailPoints)
    const points = generateOrbitTrailPoints(sat.tle1, sat.tle2, TRAIL_DURATION_MINUTES, TRAIL_POINTS);
    if(points.length > 0){
      const path = new WorldWind.Path(points);
      path.altitudeMode = WorldWind.RELATIVE_TO_GROUND;
      path.attributes = new WorldWind.ShapeAttributes(null);
      const color = (ORBIT_COLORS[(sat.type||'unknown').toLowerCase()] || ORBIT_COLORS.unknown);
      path.attributes.outlineColor = color;
      path.attributes.outlineWidth = 3;
      trailRenderable = path;
      trailLayer.addRenderable(path);
    }
    // ensure info & follow button
    if(sat.position){ showSatelliteInfo({ ...sat }); }
    // center camera a bit above current pos
    if(sat.position){
      wwd.navigator.lookAtLocation.latitude = sat.position.lat;
      wwd.navigator.lookAtLocation.longitude = sat.position.lon;
      wwd.navigator.range = Math.max(500000, sat.position.alt + 500000);
      wwd.redraw();
    }
  }

  // speed range UI
  document.getElementById('speed').oninput = e => { document.getElementById('speedVal').textContent = e.target.value; };

  // End of script
  </script>
</body>
</html>